---

- name: Install Microsoft Visual C++ Redistributable Latest - X86"
  ansible.windows.win_package:
    path: https://aka.ms/vs/17/release/vc_redist.x86.exe
    arguments: /q /norestart

- name: Install Microsoft Visual C++ Redistributable Latest - X64"
  ansible.windows.win_package:
    path: https://aka.ms/vs/17/release/vc_redist.x64.exe
    arguments: /q /norestart

- name: Install Microsoft .NET Framework 4.8 - Offline installer
  ansible.windows.win_package:
    path: https://go.microsoft.com/fwlink/?linkid=2088631
    arguments: /q /norestart

#When Windows Server, the following roles are needed
- name: Install Windows Server Features - Shared Desktops
  win_feature:
    name:
    - RDS-RD-Server
    - Server-Media-Foundation
    - Remote-Assistance
  state: present

- name: Reboot to complete Windows Feature installation
  ansible.windows.win_reboot:
    reboot_timeout: 3600

# Use Ryan Butler GIT for downloading the VDA
- name: Git checkout
  ansible.builtin.git:
    repo: 'https://foosball.example.org/path/to/repo.git'
    dest: /srv/checkout
    version: release-0.22

# Next one needs to be checked of escape chars and var needs to be added
- name: Install Citrix VDA 2203 
  ansible.windows.win_package:
    chdir: C:\InstallSources
    path: C:\InstallSources\VDAServerSetup_2203.exe
    arguments: /components VDA /controllers `"$($env:CitrixDeliveryControllers)`" /disableexperiencemetrics /enable_hdx_ports /enable_hdx_udp_ports /enable_real_time_transport /enable_remote_assistance /enable_ss_ports /exclude `"Citrix Telemetry Service`",`"Citrix Personalization for App-V - VDA`",`"Citrix Files for Windows`",`"Citrix Files for Outlook`",`"User personalization layer`",`"Citrix WEM Agent`",`"Citrix VDA Upgrade Agent`" /includeadditional `"Citrix MCS IODriver`" /masterimage /noreboot /quiet